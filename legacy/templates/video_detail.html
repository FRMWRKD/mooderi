{% extends "base.html" %}

{% block content %}
{% from 'components/card_video.html' import video_card %}

<div class="video-detail-header"
    style="padding: 40px; background: rgba(0,0,0,0.3); border-bottom: 1px solid var(--border-subtle);">
    <div style="max-width: 1200px; margin: 0 auto;">
        <div style="display: flex; align-items: start; gap: 32px;">
            <!-- Thumbnail / Player -->
            <div class="video-preview" style="width: 320px; flex-shrink: 0;">
                <div class="image-wrapper"
                    style="aspect-ratio: 16/9; border-radius: var(--radius-lg); overflow: hidden; position: relative;">
                    <img src="{{ video.thumbnail_url or 'https://via.placeholder.com/640x360?text=No+Thumbnail' }}"
                        alt="{{ video.title }}" style="width: 100%; height: 100%; object-fit: cover;">
                    <div class="overlay-hover"
                        style="display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.4);">
                        <a href="{{ video.url }}" target="_blank" class="btn btn-primary btn-icon"
                            style="width: 64px; height: 64px; border-radius: 50%; font-size: 24px;">
                            <i class="bi bi-play-fill" style="margin-left: 4px;"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Info -->
            <div class="video-info" style="flex: 1;">
                <div style="margin-bottom: 16px;">
                    <a href="/videos" class="text-tertiary"
                        style="font-size: 14px; text-decoration: none; display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <i class="bi bi-arrow-left"></i> Back to My Videos
                    </a>
                    <h1 style="margin-bottom: 8px;">{{ video.title or 'Untitled Video' }}</h1>
                    <div style="display: flex; gap: 16px; font-size: 14px; color: var(--text-secondary);">
                        <span><i class="bi bi-clock"></i> {{ (video.duration / 60)|int if video.duration else 0 }}m {{
                            (video.duration % 60) if video.duration else 0 }}s</span>
                        <span><i class="bi bi-images"></i> {{ video.frame_count }} frames</span>
                        <span><i class="bi bi-calendar"></i> {{ video.created_at[:10] }}</span>
                        <span style="text-transform: capitalize;"><i class="bi bi-activity"></i> {{ video.status
                            }}</span>
                    </div>
                </div>

                <div class="actions" style="display: flex; gap: 12px; margin-top: 24px;">
                    <button class="btn btn-primary" onclick="alert('Reprocess not implemented yet')">
                        <i class="bi bi-arrow-repeat"></i> Reprocess
                    </button>
                    <button class="btn btn-secondary text-danger" onclick="deleteVideo('{{ video.id }}')">
                        <i class="bi bi-trash"></i> Delete Video
                    </button>
                </div>

                <p style="margin-top: 24px; color: var(--text-secondary); font-size: 14px;">
                    Source URL: <a href="{{ video.url }}" target="_blank" style="color: var(--accent-blue);">{{
                        video.url }}</a>
                </p>
            </div>
        </div>
    </div>
</div>

<div class="content-padding" style="padding: 40px; max-width: 1400px; margin: 0 auto;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <h3 style="font-size: 20px;">Extracted Frames</h3>
        <a href="/?video_id={{ video.id }}" class="btn btn-secondary btn-sm">
            <i class="bi bi-grid"></i> View in Gallery
        </a>
    </div>

    {% if video.frames %}
    <div class="masonry-grid image-focused">
        {% for image in video.frames %}
        {{ video_card(image) }}
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state" style="text-align: center; padding: 60px 0; color: var(--text-secondary);">
        <p>No frames extracted yet. The video might still be processing.</p>
    </div>
    {% endif %}
</div>

<script>
    async function deleteVideo(id) {
        if (!confirm('Are you sure? This will delete the video and all extracted frames.')) return;
        try {
            const response = await fetch(`/api/videos/${id}?delete_frames=true`, { 
                method: 'DELETE' 
            });
            
            if (response.ok) {
                showToast('Video deleted');
                window.location.href = '/videos';
            } else {
                const data = await response.json();
                showToast(data.error || 'Failed to delete');
            }
        } catch (e) {
            console.error(e);
            showToast('Error deleting video');
        }
    }
</script>
{% endblock %}