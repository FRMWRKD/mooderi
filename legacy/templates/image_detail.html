{% extends "base.html" %}

{% block content %}
<div class="detail-wrapper">
    <!-- Clean Navigation -->
    <div class="detail-nav">
        <a href="{{ url_for('main.index') }}" class="btn-back"><i class="bi bi-arrow-left"></i> Back to Library</a>
    </div>

    <div class="detail-split-layout">
        <!-- Left Column: Main Image -->
        <div class="image-column">
            <div class="main-image-wrapper">
                <img src="{{ image.image_url }}" alt="Cinematic Preview" draggable="false">
            </div>
        </div>

        <!-- Right Column: Sidebar -->
        <div class="sidebar-column">
            <!-- Header / Actions -->
            <div class="sidebar-header">
                <div class="sidebar-actions">
                    <button class="btn-icon circle vote-btn" id="like-btn" onclick="vote({{ image.id }}, 'like')">
                        <i class="bi bi-hand-thumbs-up"></i>
                        <span id="like-count">{{ image.likes or 0 }}</span>
                    </button>
                    <button class="btn-icon circle vote-btn" id="dislike-btn" onclick="vote({{ image.id }}, 'dislike')">
                        <i class="bi bi-hand-thumbs-down"></i>
                        <span id="dislike-count">{{ image.dislikes or 0 }}</span>
                    </button>

                    <!-- Star / Favorite -->
                    <button class="btn-icon circle btn-star" data-id="{{ image.id }}" title="Save to Board">
                        <i class="bi bi-star"></i>
                    </button>

                    <!-- Share -->
                    <button class="btn-icon circle" title="Share">
                        <i class="bi bi-share"></i>
                    </button>

                    <!-- Download -->
                    <a href="{{ image.image_url }}" download target="_blank" class="btn-icon circle"
                        title="Download Image">
                        <i class="bi bi-download"></i>
                    </a>
                </div>
            </div>

            <!-- Tabs -->
            <div class="sidebar-tabs">
                <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
                <button class="tab-btn" onclick="switchTab('analysis')">Analysis</button>
                <button class="tab-btn" onclick="switchTab('prompts')">AI Prompts</button>
            </div>

            <!-- Tab Content: Overview (Prompt First, then Video, Basic Info) -->
            <div id="tab-overview" class="tab-content active">
                <!-- PROMPT - Primary Focus -->
                <div class="detail-block prompt-hero">
                    <div class="prompt-header">
                        <h3 class="tab-heading">Prompt</h3>
                        <button class="btn-copy-hero"
                            onclick="copyPrompt(`{{ image.prompt | replace('`', '\\`') | replace('\n', ' ') }}`)">
                            <i class="bi bi-clipboard"></i> Copy Prompt
                        </button>
                    </div>
                    {% if image.prompt and image.prompt|length > 200 %}
                    <div class="prompt-text prompt-truncated" id="prompt-truncated">{{ image.prompt[:200] }}...</div>
                    <div class="prompt-text prompt-full" id="prompt-full" style="display: none;">{{ image.prompt }}
                    </div>
                    <button class="btn-expand" id="btn-expand-prompt" onclick="togglePrompt()">
                        <i class="bi bi-chevron-down"></i> Show more
                    </button>
                    {% else %}
                    <div class="prompt-text">{{ image.prompt or '-' }}</div>
                    {% endif %}
                </div>

                <!-- Video Source -->
                {% if image.source_video_url %}
                <div class="detail-block">
                    <h3 class="tab-heading">Reference Video</h3>
                    <div class="video-embed-small">
                        {% set video_id = image.source_video_url.split('v=')[-1].split('&')[0] if 'v=' in
                        image.source_video_url else image.source_video_url.split('/')[-1] %}
                        <iframe
                            src="https://www.youtube.com/embed/{{ video_id }}{% if image.scene_start_time %}?start={{ image.scene_start_time|int }}{% endif %}"
                            frameborder="0" allowfullscreen>
                        </iframe>
                    </div>
                    <div class="video-meta-row">
                        {% if image.scene_start_time %}
                        <div class="timestamp-pill">
                            <i class="bi bi-clock-history"></i> {{ "%.1f"|format(image.scene_start_time) }}s
                        </div>
                        {% endif %}
                        <a href="{{ image.source_video_url }}{% if image.scene_start_time %}&t={{ image.scene_start_time|int }}{% endif %}"
                            target="_blank" class="btn-text-link">
                            Open in YouTube <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- Properties Row -->
                <div class="detail-block">
                    <h3 class="tab-heading">Properties</h3>
                    <div class="props-row-inline">
                        <span class="prop-pill"><strong>Mood:</strong> {{ image.mood }}</span>
                        <span class="prop-pill"><strong>Lighting:</strong> {{ image.lighting }}</span>
                    </div>
                </div>

                <!-- Colors -->
                <div class="detail-block">
                    <h3 class="tab-heading">Colors</h3>
                    <div class="palette-row">
                        {% for color in image.colors %}
                        <a href="/search?color={{ color|urlencode }}" class="palette-chip"
                            style="background-color: {{ color }}" title="{{ color }}">
                        </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Tags -->
                <div class="detail-block">
                    <h3 class="tab-heading">Tags</h3>
                    <div class="tags-row">
                        {% for tag in image.tags %}
                        <a href="/search?tag={{ tag }}" class="tag-link">#{{ tag }}</a>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Tab Content: Analysis (Detailed Metadata) -->
            <div id="tab-analysis" class="tab-content">
                {% set analysis_text = image.generated_prompts.visionati_analysis if (image.generated_prompts and
                image.generated_prompts.visionati_analysis) else image.prompt %}
                {% set structured = image.generated_prompts.structured_analysis if (image.generated_prompts and
                image.generated_prompts.structured_analysis) else none %}

                {% if analysis_text or structured %}
                <!-- Copy Button Header -->
                <div class="detail-block" style="padding-bottom: 8px;">
                    <div class="prompt-header" style="margin-bottom: 0;">
                        <h3 class="tab-heading">AI Analysis</h3>
                        <button class="btn-copy-hero" onclick="copyAnalysis()">
                            <i class="bi bi-clipboard"></i> Copy Full
                        </button>
                    </div>
                </div>

                {% if structured %}
                <!-- Structured Analysis Collapsible Sections -->

                <!-- Short Description - Always visible at top -->
                {% if structured.short_description %}
                <div class="detail-block"
                    style="padding: 12px 14px; margin-bottom: 8px; background: rgba(139, 92, 246, 0.08); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 8px;">
                    <p style="font-size: 13px; line-height: 1.6; color: var(--text-primary); margin: 0;">{{
                        structured.short_description }}</p>
                </div>
                {% endif %}

                <!-- Subjects -->
                {% if structured.subjects %}
                <div class="analysis-section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <i class="bi bi-chevron-right"></i>
                        <span>Subjects</span>
                        <span class="section-count">{{ structured.subjects|length }}</span>
                    </div>
                    <div class="section-content">
                        {% for subject in structured.subjects %}
                        <div class="section-item">
                            {% if subject.type %}<span class="item-label">{{ subject.type }}</span>{% endif %}
                            {% if subject.description %}<p>{{ subject.description }}</p>{% endif %}
                            {% if subject.location %}<p><strong>Location:</strong> {{ subject.location }}</p>{% endif %}
                            {% if subject.clothing %}<p><strong>Clothing:</strong> {{ subject.clothing }}</p>{% endif %}
                            {% if subject.action %}<p><strong>Action:</strong> {{ subject.action }}</p>{% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Environment -->
                {% if structured.environment %}
                <div class="analysis-section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <i class="bi bi-chevron-right"></i>
                        <span>Environment</span>
                    </div>
                    <div class="section-content">
                        {% if structured.environment.setting %}<p><strong>Setting:</strong> {{
                            structured.environment.setting }}</p>{% endif %}
                        {% if structured.environment.background %}<p><strong>Background:</strong> {{
                            structured.environment.background }}</p>{% endif %}
                        {% if structured.environment.atmosphere %}<p><strong>Atmosphere:</strong> {{
                            structured.environment.atmosphere }}</p>{% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Lighting -->
                {% if structured.lighting %}
                <div class="analysis-section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <i class="bi bi-chevron-right"></i>
                        <span>Lighting</span>
                    </div>
                    <div class="section-content">
                        {% if structured.lighting.type %}<p><strong>Type:</strong> {{ structured.lighting.type }}</p>{%
                        endif %}
                        {% if structured.lighting.direction %}<p><strong>Direction:</strong> {{
                            structured.lighting.direction }}</p>{% endif %}
                        {% if structured.lighting.quality %}<p><strong>Quality:</strong> {{ structured.lighting.quality
                            }}</p>{% endif %}
                        {% if structured.lighting.shadows %}<p><strong>Shadows:</strong> {{ structured.lighting.shadows
                            }}</p>{% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Camera -->
                {% if structured.camera %}
                <div class="analysis-section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <i class="bi bi-chevron-right"></i>
                        <span>Camera</span>
                    </div>
                    <div class="section-content">
                        {% if structured.camera.shot_type %}<p><strong>Shot:</strong> {{ structured.camera.shot_type }}
                        </p>{% endif %}
                        {% if structured.camera.angle %}<p><strong>Angle:</strong> {{ structured.camera.angle }}</p>{%
                        endif %}
                        {% if structured.camera.depth_of_field %}<p><strong>Depth of Field:</strong> {{
                            structured.camera.depth_of_field }}</p>{% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Colors -->
                {% if structured.colors %}
                <div class="analysis-section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <i class="bi bi-chevron-right"></i>
                        <span>Colors</span>
                    </div>
                    <div class="section-content">
                        {% if structured.colors.dominant %}<p><strong>Dominant:</strong> {{
                            structured.colors.dominant|join(', ') }}</p>{% endif %}
                        {% if structured.colors.palette %}<p><strong>Palette:</strong> {{ structured.colors.palette }}
                        </p>{% endif %}
                        {% if structured.colors.saturation %}<p><strong>Saturation:</strong> {{
                            structured.colors.saturation }}</p>{% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Mood -->
                {% if structured.mood %}
                <div class="analysis-section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <i class="bi bi-chevron-right"></i>
                        <span>Mood & Style</span>
                    </div>
                    <div class="section-content">
                        {% if structured.mood.emotion %}<p><strong>Emotion:</strong> {{ structured.mood.emotion }}</p>{%
                        endif %}
                        {% if structured.mood.energy %}<p><strong>Energy:</strong> {{ structured.mood.energy }}</p>{%
                        endif %}
                        {% if structured.mood.style %}<p><strong>Style:</strong> {{ structured.mood.style }}</p>{% endif
                        %}
                    </div>
                </div>
                {% endif %}

                {% else %}
                <!-- Fallback: Text Analysis -->
                <div class="analysis-section">
                    <div class="section-header" onclick="toggleSection(this)">
                        <i class="bi bi-chevron-right"></i>
                        <span>Full Analysis</span>
                    </div>
                    <div class="section-content">
                        <p style="font-size: 12px; line-height: 1.7; color: var(--text-secondary);">{{ analysis_text }}
                        </p>
                    </div>
                </div>
                {% endif %}

                <!-- Hidden element for copy function -->
                <textarea id="analysis-copy-text"
                    style="position: absolute; left: -9999px;">{{ analysis_text or (structured | tojson if structured else '') }}</textarea>
                {% else %}
                <div class="detail-block">
                    <p class="text-small">No analysis available for this image yet.</p>
                </div>
                {% endif %}
            </div>

            <!-- Tab Content: AI Prompts -->
            <div id="tab-prompts" class="tab-content">
                <!-- Generated Prompts -->
                <div id="prompts-container">
                    <!-- Text-to-Image -->
                    <div class="detail-block prompt-output">
                        <div class="prompt-output-header">
                            <span class="prompt-type-label">Text-to-Image</span>
                            <button class="btn-copy-small" onclick="copyPromptType('tti')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                        <div id="prompt-tti" class="prompt-output-text">
                            {% if image.generated_prompts and image.generated_prompts.text_to_image %}
                            {{ image.generated_prompts.text_to_image }}
                            {% else %}
                            -
                            {% endif %}
                        </div>
                    </div>

                    <!-- Image-to-Image -->
                    <div class="detail-block prompt-output">
                        <div class="prompt-output-header">
                            <span class="prompt-type-label">Image-to-Image</span>
                            <button class="btn-copy-small" onclick="copyPromptType('iti')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                        <div id="prompt-iti" class="prompt-output-text">
                            {% if image.generated_prompts and image.generated_prompts.image_to_image %}
                            {{ image.generated_prompts.image_to_image }}
                            {% else %}
                            -
                            {% endif %}
                        </div>
                    </div>

                    <!-- Text-to-Video -->
                    <div class="detail-block prompt-output">
                        <div class="prompt-output-header">
                            <span class="prompt-type-label">Text-to-Video</span>
                            <button class="btn-copy-small" onclick="copyPromptType('ttv')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                        </div>
                        <div id="prompt-ttv" class="prompt-output-text">
                            {% if image.generated_prompts and image.generated_prompts.text_to_video %}
                            {{ image.generated_prompts.text_to_video }}
                            {% else %}
                            -
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Similar Section (Full Width Below) -->
    <!-- Similar Section (Infinite Grid) -->
    <div class="similar-section-full">
        <div class="similar-header">More like this</div>
        <div class="similar-grid" id="similar-grid">
            {% if similar_images %}
            {% for img in similar_images %}
            <div class="similar-item" onclick="window.location.href='/image/{{ img.id }}'">
                <img src="{{ img.image_url }}" alt="Similar" loading="lazy">
            </div>
            {% endfor %}
            {% endif %}
        </div>

        <div class="loading-spinner" id="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>
</div>

<style>
    .detail-wrapper {
        max-width: 95vw;
        /* Much wider for big image */
        margin: 0 auto;
        padding-bottom: 60px;
    }

    .detail-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
        max-width: 1600px;
        margin-left: auto;
        margin-right: auto;
    }

    .btn-back {
        color: var(--text-secondary);
        text-decoration: none;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: color 0.2s;
    }

    .btn-back:hover {
        color: var(--text-primary);
    }

    .detail-actions {
        display: flex;
        gap: 12px;
    }

    /* Fixed Layout Updates */
    .detail-split-layout {
        display: flex;
        gap: 40px;
        margin-top: 24px;
        align-items: flex-start;
        /* Important for sticky sidebar */
        position: relative;
        justify-content: center;
    }

    /* Left Column: Image */
    .image-column {
        flex: 1;
        /* Allow it to grow big */
        background: transparent;
        border-radius: 20px;
        overflow: visible;
        /* Don't clip shadows */
        display: flex;
        align-items: flex-start;
        justify-content: center;
        min-height: 500px;
        /* No max-width - let it be as big as viewport allows */
    }

    .main-image-wrapper {
        width: 100%;
        display: flex;
        justify-content: center;
    }

    .main-image-wrapper img {
        width: 100%;
        height: auto;
        /* No max-height - user wants HUGE image */
        object-fit: contain;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    }

    /* Right Column: Sidebar - Sticky */
    .sidebar-column {
        width: 380px;
        /* Slightly narrower to give more space to image */
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 20px;
        overflow: hidden;
        position: sticky;
        top: 24px;
        max-height: calc(100vh - 48px);
        /* Full height minus margin */
    }

    /* Tabs */
    .sidebar-tabs {
        display: flex;
        padding: 4px;
        margin: 16px 16px 0;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        flex-shrink: 0;
    }

    .tab-btn {
        flex: 1;
        padding: 10px 12px;
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-weight: 600;
        font-size: 12px;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .tab-btn.active {
        background: rgba(255, 255, 255, 0.08);
        color: var(--text-primary);
    }

    .tab-content {
        display: none;
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        scrollbar-width: thin;
    }

    .tab-content.active {
        display: block;
    }

    .tab-heading {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        font-weight: 700;
    }

    .detail-block {
        margin-bottom: 20px;
    }

    /* Prompt Hero - Primary Focus */
    .prompt-hero {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 16px;
    }

    .prompt-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .prompt-header .tab-heading {
        margin-bottom: 0;
    }

    .btn-copy-hero {
        background: var(--accent);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s;
    }

    .btn-copy-hero:hover {
        background: #7c5ce0;
        transform: scale(1.02);
    }

    .prompt-text {
        font-size: 13px;
        line-height: 1.6;
        color: var(--text-primary);
        font-family: 'JetBrains Mono', monospace;
    }

    .btn-expand {
        background: transparent;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        margin-top: 8px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .btn-expand:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
    }

    .btn-expand i {
        transition: transform 0.2s;
    }

    .btn-expand.expanded i {
        transform: rotate(180deg);
    }

    /* Collapsible Analysis Sections */
    .analysis-section {
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 8px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.02);
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 14px;
        cursor: pointer;
        transition: background 0.2s;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
    }

    .section-header:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .section-header i {
        font-size: 12px;
        color: var(--text-secondary);
        transition: transform 0.2s;
    }

    .section-header.open i {
        transform: rotate(90deg);
    }

    .section-count {
        margin-left: auto;
        background: rgba(139, 92, 246, 0.2);
        color: rgb(167, 139, 250);
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 11px;
        font-weight: 600;
    }

    .section-content {
        display: none;
        padding: 0 14px 14px 14px;
        border-top: 1px solid var(--border-color);
    }

    .section-content p {
        margin: 8px 0;
        font-size: 12px;
        line-height: 1.6;
        color: var(--text-secondary);
    }

    .section-content strong {
        color: var(--text-primary);
    }

    .section-item {
        padding: 10px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .section-item:last-child {
        border-bottom: none;
    }

    .item-label {
        background: rgba(99, 102, 241, 0.15);
        color: rgb(129, 140, 248);
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 10px;
        text-transform: uppercase;
        font-weight: 600;
        margin-bottom: 6px;
        display: inline-block;
    }

    .section-item small {
        display: block;
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 4px;
    }


    /* Video Embed */
    .video-embed-small {
        border-radius: 10px;
        overflow: hidden;
        position: relative;
        padding-bottom: 56.25%;
        margin-bottom: 10px;
        background: #000;
    }

    .video-embed-small iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }

    .video-meta-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .timestamp-pill {
        background: rgba(255, 255, 255, 0.06);
        color: var(--text-secondary);
        padding: 4px 10px;
        border-radius: 100px;
        font-size: 11px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .btn-text-link {
        color: var(--text-secondary);
        font-size: 12px;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .btn-text-link:hover {
        color: var(--accent);
    }

    /* Properties Inline Row */
    .props-row-inline {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .prop-pill {
        background: rgba(255, 255, 255, 0.05);
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        color: var(--text-secondary);
    }

    .prop-pill strong {
        color: var(--text-primary);
    }

    /* Colors */
    .palette-row {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }

    .palette-chip {
        width: 28px;
        height: 28px;
        border-radius: 6px;
        cursor: pointer;
        transition: transform 0.2s;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .palette-chip:hover {
        transform: scale(1.15);
    }

    /* Tags */
    .tags-row {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
    }

    .tag-link {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-secondary);
        padding: 4px 10px;
        border-radius: 100px;
        font-size: 11px;
        text-decoration: none;
        transition: all 0.2s;
    }

    .tag-link:hover {
        background: var(--accent);
        color: white;
    }

    .meta-section {
        margin-bottom: 12px;
    }

    .meta-label {
        font-size: 11px;
        font-weight: 600;
        color: var(--text-primary);
        display: block;
        margin-bottom: 4px;
    }

    .text-small {
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.5;
    }

    /* Sidebar Header */
    .sidebar-header {
        padding: 12px 16px;
        border-bottom: 1px solid var(--border-color);
    }

    .sidebar-actions {
        display: flex;
        justify-content: flex-start;
        gap: 8px;
    }

    .btn-icon.circle {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        font-size: 14px;
    }

    .btn-icon.circle:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-primary);
    }

    .btn-icon.circle.primary {
        background: var(--gradient-primary);
        color: white;
        border: none;
    }

    .vote-btn {
        gap: 4px;
        width: auto;
        padding: 0 12px;
        border-radius: 18px;
    }

    .vote-btn span {
        font-size: 12px;
        font-weight: 600;
    }

    /* Similar Section: Infinite Grid */
    .similar-section-full {
        margin-top: 60px;
        padding-top: 40px;
        border-top: 1px solid var(--border-color);
    }

    .similar-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 24px;
    }

    .similar-item {
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 16/9;
        cursor: pointer;
        transition: transform 0.2s;
        background: var(--bg-card);
    }

    .similar-item:hover {
        transform: translateY(-4px);
    }

    .similar-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .loading-spinner {
        text-align: center;
        padding: 40px;
        color: var(--text-secondary);
        display: none;
    }

    .loading-spinner.active {
        display: block;
    }

    /* AI Prompts Tab Styles */
    .prompts-loading {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 20px;
        color: var(--text-secondary);
    }

    .spinner-small {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-top-color: var(--text-secondary);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .copy-all-row {
        margin-bottom: 16px;
    }

    .btn-copy-all {
        width: 100%;
        background: linear-gradient(135deg, var(--accent), #a855f7);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.2s;
    }

    .btn-copy-all:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
    }

    .prompt-output {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--border-color);
        border-radius: 10px;
        padding: 12px;
    }

    .prompt-output-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .prompt-type-label {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: var(--text-primary);
    }

    .btn-copy-small {
        background: rgba(255, 255, 255, 0.06);
        border: none;
        color: var(--text-secondary);
        width: 28px;
        height: 28px;
        border-radius: 6px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .btn-copy-small:hover {
        background: rgba(255, 255, 255, 0.12);
        color: var(--text-primary);
    }

    .prompt-output-text {
        font-size: 12px;
        line-height: 1.5;
        color: var(--text-secondary);
        font-family: 'JetBrains Mono', monospace;
        word-break: break-word;
        max-height: 100px;
        overflow-y: auto;
    }

    .copy-toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--accent);
        color: white;
        padding: 12px 24px;
        border-radius: 100px;
        font-weight: 600;
        font-size: 14px;
        z-index: 9999;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .copy-toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    /* Responsive */
    @media (max-width: 1000px) {
        .detail-split-layout {
            flex-direction: column;
        }

        .sidebar-column {
            width: 100%;
            position: static;
            max-height: none;
        }

        .image-column {
            min-height: auto;
        }
    }
</style>

<script>
    function switchTab(tabId) {
        // Toggle buttons
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // Toggle content
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
    }

    function togglePrompt() {
        const truncated = document.getElementById('prompt-truncated');
        const full = document.getElementById('prompt-full');
        const btn = document.getElementById('btn-expand-prompt');

        if (truncated.style.display === 'none') {
            truncated.style.display = 'block';
            full.style.display = 'none';
            btn.innerHTML = '<i class="bi bi-chevron-down"></i> Show more';
            btn.classList.remove('expanded');
        } else {
            truncated.style.display = 'none';
            full.style.display = 'block';
            btn.innerHTML = '<i class="bi bi-chevron-up"></i> Show less';
            btn.classList.add('expanded');
        }
    }

    function toggleSection(header) {
        const content = header.nextElementSibling;
        const icon = header.querySelector('i');

        if (content.style.display === 'block') {
            content.style.display = 'none';
            header.classList.remove('open');
            icon.className = 'bi bi-chevron-right';
        } else {
            content.style.display = 'block';
            header.classList.add('open');
            icon.className = 'bi bi-chevron-down';
        }
    }

    function toggleAnalysis() {
        const truncated = document.getElementById('analysis-truncated');
        const full = document.getElementById('analysis-full');
        const btn = document.getElementById('btn-expand-analysis');

        if (truncated.style.display === 'none') {
            truncated.style.display = 'block';
            full.style.display = 'none';
            btn.innerHTML = '<i class="bi bi-chevron-down"></i> Show more';
            btn.classList.remove('expanded');
        } else {
            truncated.style.display = 'none';
            full.style.display = 'block';
            btn.innerHTML = '<i class="bi bi-chevron-up"></i> Show less';
            btn.classList.add('expanded');
        }
    }

    function vote(imageId, type) {
        fetch(`/api/vote/${imageId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: type })
        })
            .then(res => res.json())
            .then(data => {
                if (data.error) {
                    console.error(data.error);
                    return;
                }
                document.getElementById('like-count').textContent = data.likes;
                document.getElementById('dislike-count').textContent = data.dislikes;

                // Visual feedback
                const btn = type === 'like' ? document.getElementById('like-btn') : document.getElementById('dislike-btn');
                btn.classList.add('active');
                btn.style.transform = 'scale(1.2)';
                setTimeout(() => btn.style.transform = 'scale(1)', 200);
            })
            .catch(err => console.error('Vote error:', err));
    }

    // Infinite Scroll Logic
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;
    const imageId = {{ image.id }};

    window.addEventListener('scroll', () => {
        if (isLoading || !hasMore) return;

        // Check if near bottom of page
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
            loadMoreSimilar();
        }
    });

    function loadMoreSimilar() {
        isLoading = true;
        document.getElementById('loading-spinner').classList.add('active');

        currentPage++;

        fetch(`/api/image/${imageId}/similar?page=${currentPage}&limit=12`)
            .then(res => res.json())
            .then(data => {
                if (data.images && data.images.length > 0) {
                    const grid = document.getElementById('similar-grid');
                    data.images.forEach(img => {
                        const div = document.createElement('div');
                        div.className = 'similar-item';
                        div.onclick = () => window.location.href = `/image/${img.id}`;
                        div.innerHTML = `<img src="${img.image_url}" alt="Similar" loading="lazy">`;
                        grid.appendChild(div);
                    });
                }

                hasMore = data.has_more;
                isLoading = false;
                document.getElementById('loading-spinner').classList.remove('active');
            })
            .catch(err => {
                console.error('Error loading more:', err);
                isLoading = false;
            });
    }

    // AI Prompt Generation
    let generatedPrompts = {
        text_to_image: `{{ image.generated_prompts.text_to_image if image.generated_prompts else '' }}`,
        image_to_image: `{{ image.generated_prompts.image_to_image if image.generated_prompts else '' }}`,
        text_to_video: `{{ image.generated_prompts.text_to_video if image.generated_prompts else '' }}`
    };

    // If prompts exist, update button state
    document.addEventListener('DOMContentLoaded', () => {
        {% if image.generated_prompts %}
        const btn = document.getElementById('generate-prompts-btn');
        if (btn) {
            btn.innerHTML = '<i class="bi bi-check-circle"></i> Generated';
        }
        {% endif %}
    });

    function generatePrompts(imageId) {
        const btn = document.getElementById('generate-prompts-btn');
        const loading = document.getElementById('prompts-loading');
        const container = document.getElementById('prompts-container');

        btn.disabled = true;
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Generating...';
        loading.style.display = 'flex';
        container.style.display = 'none';

        fetch(`/api/image/${imageId}/generate-prompts`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
            .then(res => res.json())
            .then(data => {
                loading.style.display = 'none';

                if (data.error) {
                    btn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Error';
                    alert('Failed to generate prompts: ' + data.error);
                    return;
                }

                // Store prompts
                generatedPrompts.text_to_image = data.text_to_image || '';
                generatedPrompts.image_to_image = data.image_to_image || '';
                generatedPrompts.text_to_video = data.text_to_video || '';

                // Display prompts
                document.getElementById('prompt-tti').textContent = truncatePrompt(generatedPrompts.text_to_image);
                document.getElementById('prompt-iti').textContent = truncatePrompt(generatedPrompts.image_to_image);
                document.getElementById('prompt-ttv').textContent = truncatePrompt(generatedPrompts.text_to_video);

                container.style.display = 'block';
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Generated';

                if (data.cached) {
                    btn.innerHTML = '<i class="bi bi-check-circle"></i> From Cache';
                }
            })
            .catch(err => {
                loading.style.display = 'none';
                btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Retry';
                btn.disabled = false;
                console.error('Generate prompts error:', err);
            });
    }

    function truncatePrompt(text) {
        if (!text) return '-';
        if (text.length <= 200) return text;
        return text.substring(0, 200) + '...';
    }

    function copyPromptType(type) {
        let text = '';
        if (type === 'tti') text = generatedPrompts.text_to_image;
        else if (type === 'iti') text = generatedPrompts.image_to_image;
        else if (type === 'ttv') text = generatedPrompts.text_to_video;

        if (!text) {
            alert('No prompt generated yet!');
            return;
        }

        navigator.clipboard.writeText(text).then(() => {
            // Visual feedback
            const label = type === 'tti' ? 'Text-to-Image' : (type === 'iti' ? 'Image-to-Image' : 'Text-to-Video');
            showCopyFeedback(label + ' prompt copied!');
        });
    }

    function copyAnalysis() {
        const textarea = document.getElementById('analysis-copy-text');
        if (!textarea || !textarea.value) {
            alert('No analysis available!');
            return;
        }
        navigator.clipboard.writeText(textarea.value).then(() => {
            showCopyFeedback('Full analysis copied!');
        });
    }

    function copyAllPrompts() {
        const allText = `=== TEXT-TO-IMAGE ===
${generatedPrompts.text_to_image || 'Not generated'}

=== IMAGE-TO-IMAGE ===
${generatedPrompts.image_to_image || 'Not generated'}

=== TEXT-TO-VIDEO ===
${generatedPrompts.text_to_video || 'Not generated'}`;

        navigator.clipboard.writeText(allText).then(() => {
            showCopyFeedback('All prompts copied!');
        });
    }

    function showCopyFeedback(message) {
        // Create toast notification
        const toast = document.createElement('div');
        toast.className = 'copy-toast';
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => toast.classList.add('show'), 10);
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }
</script>
{% endblock %}